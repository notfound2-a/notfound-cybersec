// Init terminal
const term = new Terminal({
    cursorBlink: true,
    theme: {
        background: "#000000",
        foreground: "#00ffae",
        cursor: "#00ffae",
    }
});

term.open(document.getElementById("terminal"));

/* ──────────────────────────────
   AUDIO — from safe CDN
────────────────────────────── */
const typeSound = new Audio("https://cdn.jsdelivr.net/gh/naptha/talkify/master/sounds/keypress1.wav");
const beepSound = new Audio("https://cdn.jsdelivr.net/gh/naptha/talkify/master/sounds/keypress2.wav");
typeSound.volume = 0.4;
beepSound.volume = 0.5;

/* ──────────────────────────────
   Welcome Banner
────────────────────────────── */
function banner() {
    term.writeln("%c  404 NOT FOUND CYBERSECURITY TERMINAL", "color:#00ffae");
    term.writeln("%c  Ketik 'help' untuk melihat menu.", "color:#00ffaa");
    term.writeln("");
    term.write("> ");
}
banner();

let input = "";

/* ──────────────────────────────
   Input Handling
────────────────────────────── */
term.onData(key => {
    const printable = key >= String.fromCharCode(0x20);

    // suara ketik
    if (printable) typeSound.play();

    if (key === "\r") {
        runCommand(input.trim());
        input = "";
        term.write("\n> ");
    } else if (key === "\u007F") {
        if (input.length > 0) {
            input = input.slice(0, -1);
            term.write("\b \b");
        }
    } else if (printable) {
        input += key;
        term.write(key);
    }
});


/* ──────────────────────────────
   Command Handler
────────────────────────────── */
function runCommand(cmd) {
    const parts = cmd.split(" ");
    const command = parts[0];
    const arg = parts[1];

    switch (command) {

        /* HELP MENU */
        case "help":
            term.writeln("\n=== MENU UTAMA ===");
            term.writeln("1. whois <domain>        → Informasi pemilik domain");
            term.writeln("2. scan <domain>         → Full vulnerability scan");
            term.writeln("3. headers <domain>      → Security header check");
            term.writeln("4. dns <domain>          → DNS lookup");
            term.writeln("5. ssl <domain>          → Info certificate SSL");
            term.writeln("6. clear                 → Bersihkan terminal");
            break;


        /* CLEAR TERMINAL */
        case "clear":
            term.clear();
            banner();
            break;


        /* FULL SCAN */
        case "scan":
            if (!arg) return missingArg();
            fakeLoading("Scanning domain...");
            fetch(`api/scan.js?domain=${arg}`)
                .then(r => r.json())
                .then(d => term.writeln("\n" + d.result));
            break;


        /* WHOIS */
        case "whois":
            if (!arg) return missingArg();
            fakeLoading("Retrieving WHOIS...");
            fetch(`api/whois.js?domain=${arg}`)
                .then(r => r.json())
                .then(d => term.writeln("\n" + d.result));
            break;


        /* HEADERS */
        case "headers":
            if (!arg) return missingArg();
            fakeLoading("Checking security headers...");
            fetch(`api/headers.js?domain=${arg}`)
                .then(r => r.json())
                .then(d => term.writeln("\n" + JSON.stringify(d, null, 2)));
            break;


        /* SSL */
        case "ssl":
            if (!arg) return missingArg();
            fakeLoading("Analyzing SSL certificate...");
            fetch(`api/ssl.js?domain=${arg}`)
                .then(r => r.json())
                .then(d => term.writeln("\n" + JSON.stringify(d, null, 2)));
            break;


        /* DNS */
        case "dns":
            if (!arg) return missingArg();
            fakeLoading("Fetching DNS records...");
            fetch(`api/dns.js?domain=${arg}`)
                .then(r => r.json())
                .then(d => term.writeln("\n" + JSON.stringify(d, null, 2)));
            break;


        /* UNKNOWN COMMAND */
        default:
            beepSound.play();
            term.writeln(`\nPerintah tidak dikenal: '${cmd}'. Ketik 'help'.`);
    }
}

/* ──────────────────────────────
   MISSING ARGUMENT HANDLER
────────────────────────────── */
function missingArg() {
    beepSound.play();
    term.writeln("\n❗ Masukkan domain! Contoh: scan example.com");
}

/* ──────────────────────────────
   FAKE LOADING EFFECT
────────────────────────────── */
function fakeLoading(text) {
    term.writeln(`\n${text}`);
    term.writeln("[##########] Processing...");
}
