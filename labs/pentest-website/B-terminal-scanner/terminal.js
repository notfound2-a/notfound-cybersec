// INIT
const term = new Terminal({
    cursorBlink: true,
    theme: {
        background: "#000000",
        foreground: "#00aaff"
    }
});

const fitAddon = new FitAddon.Fit();
term.loadAddon(fitAddon);

term.open(document.getElementById("terminal"));
fitAddon.fit();


// UI
function banner() {
    term.writeln("=== 404 NOT FOUND CYBERSECURITY TERMINAL ===");
    term.writeln("Ketik angka dan domain untuk menjalankan perintah (Contoh: 1 google.com:");
    term.writeln("");
    term.writeln(" 1. Full Scan Website");
    term.writeln(" 2. Security Headers Check");
    term.writeln(" 3. SSL Certificate Info");
    term.writeln(" 4. WHOIS Lookup");
    term.writeln(" 5. DNS Lookup");
    term.writeln(" 0. Clear Screen");
    term.writeln("");
}

banner();
term.write("> ");
let input = "";


// Fungsi request API
async function fetchAPI(type, domain) {
    try {
        const req = await fetch(`api/${type}.php?domain=${domain}`);
        const res = await req.text();
        term.writeln("\n" + res + "\n");
    } catch (e) {
        term.writeln("\n[ERROR] Gagal memuat API.\n");
    }
}


// Input Handler
term.onData((data) => {
    if (data === "\r") {
        // ENTER
        handleCommand(input.trim());
        input = "";
        term.write("\n> ");
    } else if (data === "\u007F") {
        // BACKSPACE
        if (input.length > 0) {
            input = input.slice(0, -1);
            term.write("\b \b");
        }
    } else {
        term.write(data);
        input += data;
    }
});


// Handler command angka
function handleCommand(cmd) {
    switch (cmd) {

        case "0":
            term.clear();
            banner();
            break;

        case "1":
            askDomain("scan");
            break;

        case "2":
            askDomain("headers");
            break;

        case "3":
            askDomain("ssl");
            break;

        case "4":
            askDomain("whois");
            break;

        case "5":
            askDomain("dns");
            break;

        case "help":
            banner();
            break;

        default:
            term.writeln("\n[ERROR] Perintah tidak dikenal.");
    }
}


// Menanyakan domain
function askDomain(type) {
    term.writeln(`\nMasukkan domain untuk ${type}:`);
    term.write("domain> ");

    let domainInput = "";

    function listener(data) {
        if (data === "\r") {
            term.writeln("");
            fetchAPI(type, domainInput.trim());
            term.offData(listener);
            term.write("> ");
        } else if (data === "\u007F") {
            if (domainInput.length > 0) {
                domainInput = domainInput.slice(0, -1);
                term.write("\b \b");
            }
        } else {
            domainInput += data;
            term.write(data);
        }
    }

    term.onData(listener);
}
