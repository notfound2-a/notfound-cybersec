// Init terminal
const term = new Terminal({
    cursorBlink: true,
    theme: {
        background: "#000000",
        foreground: "#00ffae",
        cursor: "#00ffae",
    }
});

term.open(document.getElementById("terminal"));

/* ──────────────────────────────
   AUDIO — from safe CDN
────────────────────────────── */
const typeSound = new Audio("https://cdn.jsdelivr.net/gh/naptha/talkify/master/sounds/keypress1.wav");
const beepSound = new Audio("https://cdn.jsdelivr.net/gh/naptha/talkify/master/sounds/keypress2.wav");
typeSound.volume = 0.4;
beepSound.volume = 0.5;

/* ──────────────────────────────
   Welcome Banner
────────────────────────────── */
function banner() {
    term.writeln("%c  404 NOT FOUND CYBERSECURITY TERMINAL", "color:#00ffae");
    term.writeln("%c  Ketik 'help' untuk melihat menu.", "color:#00ffaa");
    term.writeln("");
    term.write("> ");
}
banner();

let input = "";

/* ──────────────────────────────
   INPUT HANDLER
────────────────────────────── */
term.onData(key => {
    const printable = key >= String.fromCharCode(0x20);

    if (printable) typeSound.play();

    if (key === "\r") {
        runCommand(input.trim());
        input = "";
        term.write("\n> ");
    } else if (key === "\u007F") {
        if (input.length > 0) {
            input = input.slice(0, -1);
            term.write("\b \b");
        }
    } else if (printable) {
        input += key;
        term.write(key);
    }
});

/* ──────────────────────────────
   SAFE PORT SCAN
────────────────────────────── */
async function safePortScan(target) {
    const ports = [80, 443, 8080, 3000, 5000, 22, 21];
    let results = "";

    for (let port of ports) {
        try {
            await fetch(`https://${target}:${port}`, {method:"GET",mode:"no-cors"});
            results += `${port}    open\n`;
        } catch {
            results += `${port}    closed\n`;
        }
    }
    return results;
}

/* ──────────────────────────────
   COMMAND HANDLER
────────────────────────────── */
function runCommand(cmd) {
    const parts = cmd.split(" ");
    const command = parts[0];
    const arg = parts[1];

    switch (command) {

        /* BASIC HELP */
        case "help":
            term.writeln("\n=== MENU UTAMA ===");
            term.writeln("• whois <domain>         → Info WHOIS");
            term.writeln("• scan <domain>          → Vulnerability scan");
            term.writeln("• headers <domain>       → Security headers");
            term.writeln("• dns <domain>           → DNS lookup");
            term.writeln("• ssl <domain>           → SSL info");
            term.writeln("• asn <ip/domain>        → ASN lookup");
            term.writeln("• geolocate <ip>         → GeoIP lookup");
            term.writeln("• reverse-ip <ip>        → Reverse IP (safe)");
            term.writeln("• scan-ports <target>    → Port scan (safe browser)");
            term.writeln("• shodan-lite <ip>       → Shodan versi aman");
            term.writeln("• fingerprint <domain>   → TLS fingerprint");
            term.writeln("• md5 <hash>             → Hash lookup aman");
            term.writeln("• ocr <img-url>          → OCR Extractor");
            term.writeln("• clear                  → Bersihkan terminal");
            break;

        /* CLEAR */
        case "clear":
            term.clear(); banner(); break;

        /* BASIC ORIGINAL */
        case "scan":
            if (!arg) return missingArg();
            fakeLoading("Scanning domain...");
            fetch(`api/scan.js?domain=${arg}`)
                .then(r=>r.json()).then(d=>term.writeln("\n"+d.result));
            break;

        case "whois":
            if (!arg) return missingArg();
            fakeLoading("Retrieving WHOIS...");
            fetch(`api/whois.js?domain=${arg}`)
                .then(r=>r.json()).then(d=>term.writeln("\n"+d.result));
            break;

        case "headers":
            if (!arg) return missingArg();
            fakeLoading("Checking headers...");
            fetch(`api/headers.js?domain=${arg}`)
                .then(r=>r.json()).then(d=>term.writeln("\n"+JSON.stringify(d,null,2)));
            break;

        case "ssl":
            if (!arg) return missingArg();
            fakeLoading("Checking SSL...");
            fetch(`api/ssl.js?domain=${arg}`)
                .then(r=>r.json()).then(d=>term.writeln("\n"+JSON.stringify(d,null,2)));
            break;

        case "dns":
            if (!arg) return missingArg();
            fakeLoading("DNS lookup...");
            fetch(`api/dns.js?domain=${arg}`)
                .then(r=>r.json()).then(d=>term.writeln("\n"+JSON.stringify(d,null,2)));
            break;

        /* ──────────────────────────────
           ADVANCED OSINT BELOW
        ────────────────────────────── */

        /* ASN LOOKUP */
        case "asn":
            if (!arg) return missingArg();
            fakeLoading("Fetching ASN...");
            fetch(`https://api.bgpview.io/ip/${arg}`)
                .then(r=>r.json())
                .then(d=>{
                    if (!d.data) return term.writeln("\nASN tidak ditemukan");
                    let asn=d.data.prefixes[0]?.asn || "N/A";
                    let holder=d.data.prefixes[0]?.name || "N/A";
                    term.writeln(`\nASN: ${asn}\nHolder: ${holder}`);
                });
            break;

        /* GEOIP */
        case "geolocate":
            if (!arg) return missingArg();
            fakeLoading("GeoIP lookup...");
            fetch(`https://ipapi.co/${arg}/json/`)
                .then(r=>r.json())
                .then(d=>term.writeln("\n"+JSON.stringify(d,null,2)));
            break;

        /* REVERSE IP SAFE */
        case "reverse-ip":
            if (!arg) return missingArg();
            fakeLoading("Reverse IP (safe)...");
            fetch(`https://api.hackertarget.com/reverseiplookup/?q=${arg}`)
                .then(r=>r.text())
                .then(t=>term.writeln("\n"+t));
            break;

        /* PORT SCAN SAFE */
        case "scan-ports":
            if (!arg) return missingArg();
            fakeLoading("Scanning ports (safe)...");
            safePortScan(arg).then(res=>term.writeln("\n"+res));
            break;

        /* SHODAN-LITE (SAFE) */
        case "shodan-lite":
            if (!arg) return missingArg();
            fakeLoading("Collecting OSINT...");

            Promise.all([
                fetch(`https://ipapi.co/${arg}/json/`).then(r=>r.json()),
                fetch(`https://api.bgpview.io/ip/${arg}`).then(r=>r.json()),
            ]).then(([geo,asn])=>{
                term.writeln("\n=== SHODAN-LITE SAFE ===");
                term.writeln("IP: "+arg);
                term.writeln("Country: "+geo.country_name);
                term.writeln("Region: "+geo.region);
                term.writeln("City: "+geo.city);
                term.writeln("ASN: "+(asn.data?.prefixes[0]?.asn || "N/A"));
                term.writeln("ISP: "+(asn.data?.prefixes[0]?.name || "N/A"));
            });

            break;

        /* TLS FINGERPRINT */
        case "fingerprint":
            if (!arg) return missingArg();
            fakeLoading("Getting TLS fingerprint...");
            fetch(`https://api.hackertarget.com/sslinfo/?q=${arg}`)
                .then(r=>r.text()).then(t=>term.writeln("\n"+t));
            break;

        /* MD5 SAFE LOOKUP */
        case "md5":
            if (!arg) return missingArg();
            fakeLoading("Checking hash...");
            term.writeln(`\nMD5 Hash: ${arg}`);
            term.writeln("DB lookup (safe): No sensitive data stored.");
            break;

        /* OCR EXTRACTOR */
        case "ocr":
            if (!arg) return missingArg();
            fakeLoading("Extracting text...");
            fetch(`https://api.ocr.space/parse/imageurl?apikey=helloworld&url=${arg}`)
                .then(r=>r.json())
                .then(d=>term.writeln("\n"+d.ParsedResults?.[0]?.ParsedText || "No text found"));
            break;

        /* UNKNOWN COMMAND */
        default:
            beepSound.play();
            term.writeln(`\nPerintah tidak dikenal: '${cmd}'. Ketik 'help'.`);
    }
}

/* ──────────────────────────────
   MISSING ARGUMENT HANDLER
────────────────────────────── */
function missingArg() {
    beepSound.play();
    term.writeln("\n❗ Masukkan argumen! Contoh: asn 8.8.8.8");
}

/* ──────────────────────────────
   FAKE LOADING EFFECT
────────────────────────────── */
function fakeLoading(text) {
    term.writeln(`\n${text}`);
    term.writeln("[##########] Processing...");
}
